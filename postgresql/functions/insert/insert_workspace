CREATE OR REPLACE FUNCTION public.insert_workspace(
	arg_account_index integer,
	arg_workspace_name character varying,
	arg_visibility integer,
	arg_cloud_container_name character varying,
	arg_account_permission integer)
    RETURNS integer
    LANGUAGE 'plpgsql'

    COST 100
    VOLATILE

AS $BODY$
DECLARE
	check_query INTEGER:= -1;
	cur_id_workspace INTEGER;
	cur_id_account INTEGER;
	select_query INTEGER;
	check_name CHARACTER varying(32);
BEGIN
	select_query := (SELECT id FROM public.account
					 	WHERE id = arg_account_index);
	IF select_query is NULL THEN
		check_query := 123;
		return check_query;
	ELSE
		check_name := (SELECT name FROM public.workspace
					   	INNER JOIN public.ref_account_workspace ON public.workspace.id = public.ref_account_workspace.id_workspace
					   		WHERE public.ref_account_workspace.id_account = select_query AND
					   		      public.workspace.visibility = arg_visibility AND
					   		      public.workspace.name=arg_workspace_name);
		IF check_name is NULL THEN
			INSERT INTO public.workspace(name,visibility, admin_id)
				VALUES (arg_workspace_name, arg_visibility, arg_account_index)
				RETURNING id INTO cur_id_workspace;

			UPDATE public.account set default_workspace = cur_id_workspace
				WHERE id = select_query
			    RETURNING id INTO cur_id_account;

			INSERT INTO public.ref_account_workspace(id_account, id_workspace, account_permission)
				VALUES (cur_id_account, cur_id_workspace, arg_account_permission);

			INSERT INTO public.azure_cloud_container(cloud_container_name, workspace_id)
				VALUES (arg_cloud_container_name, cur_id_workspace);
			check_query := 0;
		ELSE
			check_query := 170;
		END IF;
		return check_query;
	END IF;
END; $BODY$;
