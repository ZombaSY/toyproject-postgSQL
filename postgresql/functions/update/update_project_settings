CREATE OR REPLACE FUNCTION public.update_project_settings(
	arg_account_index integer,
	arg_project_index integer,
	arg_project_visibility integer,
	arg_project_name text,
	arg_project_description text)
    RETURNS integer
    LANGUAGE 'plpgsql'

    COST 100
    VOLATILE

AS $BODY$
DECLARE
	v_user_permission INTEGER;
    v_user_state INTEGER;
	return_code INTEGER;
BEGIN
	-- Check account's permission --
	v_user_permission := (SELECT user_permission FROM public.ref_account_project
						  	WHERE id_account = arg_account_index AND id_project = arg_project_index);

	IF v_user_permission = 1 THEN	-- Is Maintainer --

		-- Update project settings --
		UPDATE public.project
			SET visibility = arg_project_visibility, name = arg_project_name, description = arg_project_description
			WHERE public.project.id = arg_project_index;

		CASE arg_project_visibility
			WHEN 0 THEN
			    v_user_state := 0;
			WHEN 1 THEN
			    v_user_state := 1;
			ELSE
			    return_code := -101;    -- Invalid visibility parameter --
			    RETURN return_code;
		END CASE;

		-- Change user_state who already belonged to projects --
		UPDATE public.ref_account_project
			SET user_state = v_user_state
			WHERE id_project = arg_project_index;

		return_code := 0;
		RETURN return_code;
	ELSE
		return_code := -100;	-- Permission Denied --
		RETURN return_code;
	END IF;
END;
$BODY$;